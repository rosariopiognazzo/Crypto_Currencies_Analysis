---
title: "Crypto currencies Analysis"
author: "Rosario Pio Gnazzo"
date: "2024-05-02"
output: 
  html_document:
    fig_width: 9
    fig_height: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE, 
                      fig.align='center')
library(ggplot2)
library(fpp)
library(quantmod)
library(dygraphs)
library(seasonal)
library(gridExtra)
library(corrplot)
library(gplots)
library(scatterplot3d)
library(reshape2)
library(imputeTS)
library(fpp2)
library(glmnet)
library(caret)
```

## **Introduzione**

Il seguente progetto di analisi delle serie storiche, ha come scopo quello di esaminare l'andamento sul mercato delle monete digitali delle tre criptovalute con la maggiore capitalizzazione attuale, confrontandole con indici tradizionali come l'S&P 500 e il prezzo dell'oro. L'S&P 500, che comprende le 500 maggiori società quotate nelle borse statunitensi, e l'oro, considerato un bene rifugio, mi permetteranno di contestualizzare i comportamenti delle serie delle criptovalute all'interno del panorama economico-finanziario. L'obiettivo è quello di identificare eventuali relazioni, pattern ricorrenti e possibili trend emergenti dai dati finanziari nel corso del tempo.

Le criptovalute negli ultimi anni rappresentano un segmento significativo del mercato digitale, grazie ad una un'adozione crescente a livello globale. Tuttavia, va sottolineato che le criptovalute sono notoriamente volatili, con fluttuazioni di prezzo spesso drammatiche e difficilmente prevedibili. Nonostante questo, proverà ad effettuare delle previsioni su di esse sfruttando le tecniche viste durante il corso.

Il progetto è suddiviso nelle seguenti fasi:

-   **Analisi Descrittiva & Esplicativa**

    -   **Distribuzione nel tempo delle cryptocurrencies:** Utilizzeremo funzioni grafiche come time plots e OHLC plots per cogliere l'andamento nel tempo delle criptovalute e individuare eventuali irregolarità, disomogeneità e cambi di livello.

    -   **Analisi delle Time Series:** Cercheremo di individuare caratteristiche delle serie come trend, stagionalità e ciclicità mediante seasonal plots. Studieremo l'autovarianza, l'autocorrelazione e la stazionarietà delle serie utilizzando correlogrammi e ne calcoleremo i rendimenti.

    -   **Analisi di Dipendenze:** Utilizzeremo sia metodi grafici come scatterplot e corrplot, sia indici statistici per analizzare eventuali dipendenze tra le serie.

-   **Previsioni & Regressioni**

    -   **Decomposizione delle serie storiche:** Applicheremo il metodo migliore per decomporre le serie storiche.

    -   **Previsioni per singola cryptocurrency:** Valideremo previsioni per una singola currency utilizzando tecniche di cross-validation e diverse metriche di previsione.

    -   **Modello di regressione multivariato:** Costruiremo un modello per verificare eventualmente la possibilità di fare previsioni su una currency sfruttando le altre serie storiche.

In sintesi, il progetto si propone di analizzare le interazioni tra criptovalute, indici di mercato e beni rifugio, cercando infine di effettuare previsione dei movimenti di mercato in un contesto di alta volatilità.

## **Analisi Descrittiva & Esplicativa**

Questa prima parte dell'analisi sarà incentrata sull'aspetto descrittivo delle serie storiche. Attraverso l'uso di strumenti grafici e quantitativi, verranno descritti gli elementi caratterizzanti delle serie ed eventuali nessi tra di esse.

### **Visualizzazione delle serie storiche**

I dati che utilizzerà per l'analisi sono giornalieri e tracciano il valore dell'indice finanziario nel tempo su cinque posizioni: prezzo di apertura, prezzo più alto, più basso, prezzo di chiusura (anche aggiustato) ed il volume.

Iniziamo dunque osservando i time plot utilizzando la visualizzazione specifica per oggetti OHLC (Open, High, Low, Close and Volume), tipicamente usata per effettuare l'analisi tecnica degli indici finanziari.

#### Bitcoin (BTC-USD)

```{r}
BTC_USD <- getSymbols("BTC-USD", auto.assign = FALSE)
BTC_USD <- window(BTC_USD, end = as.Date("2024-01-01"))

dygraph(BTC_USD[, c("BTC-USD.Open", "BTC-USD.High",
                       "BTC-USD.Low", "BTC-USD.Adjusted")], 
                 main = "BTC-USD Time Series & Daily log-returs")%>%
  dyCandlestick()%>%
  dyLegend(width = 200)%>%
  dyEvent("2016-07-09", "II Halving", labelLoc = "bottom") %>%
  dyEvent("2020-05-11", "III Halving", labelLoc = "bottom") %>%
  dyEvent("2024-04-20", "IV Halving", labelLoc = "bottom") %>%
  dyRangeSelector(height = 20)

btc_data <- BTC_USD[, c("BTC-USD.Adjusted")]
```

Dal grafico giornaliero dei prezzi di chiusura di Bitcoin, possiamo evincere che dall'inizio delle transazioni fino all'inizio del 2017 il valore di BTC è rimasto pressoché invariato. Nel 2017 si osserva una crescita che porta il valore di un singolo BTC a 20.000\$, per poi decrescere durante il 2018 fino a settembre, dove inizia un'altra fase di crescita. Rimane sostanzialmente stabile durante il 2019 e l'inizio del 2020, fino a ottobre, dove si osserva un forte aumento che porta il valore di BTC da meno di 20.000\$ a superare i 60.000\$. Seguono forti oscillazioni del prezzo fino a metà 2022, quando inizia un trend di decrescita che dura fino alla fine dell'anno.

In generale, possiamo dedurre che l'andamento finanziario di BTC segua un trend crescente che, all'incirca in maniera caotica ogni 3-4 anni, subisce dei cambi di livello dovuti all'halving: è un evento programmato nel protocollo Bitcoin che si verifica ogni tre-quattro anni. Durante questo evento, la ricompensa per i miner di Bitcoin viene ridotta del 50%. Il terzo halving del Bitcoin si è verificato nel maggio del 2020, riducendo la ricompensa dei miner da circa 13 a 6 Bitcoin per blocco. Questo ha portato a una riduzione dell'offerta di nuovi Bitcoin sul mercato, contribuendo ad aumentare la domanda e quindi il prezzo di Bitcoin. Il quarto halving è avvenuto ad aprile 2024, e nella fase finale del grafico si osserva una forte impennata.

Tuttavia, altri fattori possono influenzare il prezzo, portando a incrementi vertiginosi seguiti da fasi di decrescita che riportano il valore in linea con il macro trend crescente.

#### Ethereum (ETH-USD)

```{r}
ETH_USD <- getSymbols("ETH-USD", auto.assign = FALSE)
ETH_USD <- window(ETH_USD, end = as.Date("2024-01-01"))

dygraph(ETH_USD[, c("ETH-USD.Open", "ETH-USD.High",
                       "ETH-USD.Low", "ETH-USD.Adjusted")], 
                 main = "ETH-USD Time Series & Daily log-returns")%>%
  dyCandlestick()%>%
  dyLegend(width = 200)%>%
  dyRangeSelector(height = 20)

eth_data <- ETH_USD[, c("ETH-USD.Adjusted")]
```

Osservando il grafico, notiamo chiaramente una somiglianza tra l'andamento del valore di Ethereum nel tempo e quello di Bitcoin, con la sola differenza del valore effettivo della valuta digitale, poiché il singolo Ethereum ha un valore inferiore. Questo perché Ethereum non nasce come valuta digitale, ma come una piattaforma decentralizzata basata su blockchain, progettata per consentire agli sviluppatori di creare e distribuire contratti intelligenti e applicazioni decentralizzate. L'obiettivo di Ethereum è quello di decentralizzare il web.

#### Binance Coin (BNB-USD)

```{r}
BNB_USD <- getSymbols("BNB-USD", auto.assign = FALSE)
BNB_USD <- window(BNB_USD, end = as.Date("2024-01-01"))

dygraph(BNB_USD[, c("BNB-USD.Open", "BNB-USD.High",
                       "BNB-USD.Low", "BNB-USD.Adjusted")], 
                 main = "BNB-USD Time Series & Daily log-returns")%>%
  dyCandlestick()%>%
  dyLegend(width = 200)%>%
  dyRangeSelector(height = 20)

bnb_data <- BNB_USD[, c("BNB-USD.Adjusted")]
```

Osservando l'andamento della cryptocurrency Binance BNB, la terza per capitalizzazione attuale sul mercato, notiamo che fino a metà 2020 è rimasta sostanzialmente stabile e non è stata influenzata dall'andamento delle altre due cryptocurrencies. Successivamente, si osserva un forte cambio di livello che coincide temporalmente con i cambi di livello osservati prima in BTC e poi in ETH. Anche per BNB segue una fase di decrescita e ripresa nella parte finale del periodo analizzato.

#### Oro (GC=F)

```{r}
#oro 
GOLD <- getSymbols("GC=F", auto.assign = FALSE)
GOLD <- window(GOLD, start = as.Date("2017-11-09"), 
               end = as.Date("2024-01-02"))

dygraph(GOLD[, c("GC=F.Open", "GC=F.High",
                       "GC=F.Low", "GC=F.Adjusted")], 
                 main = "GOLD Time Series")%>%
  dyCandlestick()%>%
  dyRangeSelector(height = 20)

gold_data <- GOLD[, c("GC=F.Adjusted")]
```

Si nota che dal 2017 al 2024, l'andamento dell'indice finanziario dell'oro ha mostrato una crescita costante, seppur leggera. Questo comportamento è esemplare della natura dell'oro in qualità di bene rifugio, con investitori che lo considerano un asset sicuro in tempi di incertezza economica ecco perché cresce durante il periodo del COVID. Tuttavia, osserviamo nel 2022, che l'oro ha attraversato un periodo di stallo, caratterizzato da una stabilizzazione dei prezzi senza significativi aumenti o diminuzioni. Dopo il 2022, l'oro ha ripreso la sua crescita lenta ma costante.

#### S&P 500 (GSPC)

```{r}
#sp500
SP500 <- getSymbols("^GSPC", auto.assign = FALSE)
SP500 <- window(SP500, start = as.Date("2017-11-09"), 
               end = as.Date("2024-01-02"))

dygraph(SP500[, c("GSPC.Open", "GSPC.High",
                       "GSPC.Low", "GSPC.Adjusted")], 
                 main = "S&P500 Time Series")%>%
  dyCandlestick()%>%
  dyRangeSelector(height = 20)

sp500_data <- SP500[, c("GSPC.Adjusted")]
```

Dall'analisi del grafico, possiamo dire che dal 2017 al 2024, l'indice finanziario dell'S&P 500 ha mostrato una crescita sostanziale e continua, riflettendo la generale espansione dell'economia statunitense. Tuttavia, nel 2020, l'S&P 500 ha subito un significativo crollo a causa della pandemia di COVID-19. Nonostante questo crollo, l'indice ha iniziato una ripresa rapida e robusta, che lo ha portato nel 2022 a crescere molto consolidando la sua tendenza di crescita a lungo termine.

#### Confronto fra serie storiche

Prima di confrontare le serie storiche delle tre criptovalute con gli altri due indici finanziari, è stato fondamentale utilizzare altre metodologie per rendere possibile questa analisi. Infatti, per osservare eventuali andamenti simili abbiamo dovuto effettuare:

1.  Un'interpolazione lineare per riempire i valori mancanti nelle serie storiche dell'oro e dell'S&P 500.

2.  Successivamente, tutte le serie storiche sono state standardizzate, eliminando così l'effetto scala, per poterle rappresentare sullo stesso grafico.

Questo ci permette di comparare direttamente i movimenti e le tendenze relative nel tempo, facilitando l'individuazione di pattern comuni e divergenze tra i diversi asset.

```{r, fig.height=3}
# Standardizzazione dei dati delle tre serie temporali
#
# affinchè consideri lo stesso periodo temporale tronco i dati di btc
btc_data <- subset(btc_data, index(btc_data) >= "2017-11-09")

data <- cbind(btc_data, 
              eth_data, 
              bnb_data,
              gold_data,
              sp500_data)

#per far vedere che per alcuni giorni non ci sono i valori degli indici # dell'oro e sp500
data[200:205]

# per questo vanno gestiti gli NAs
gold_r <- na_interpolation(data$GC.F.Adjusted)
ggplot_na_imputations(data$GC.F.Adjusted, gold_r,
                      theme = theme_bw())
sp500_r <- na_interpolation(data$GSPC.Adjusted)
ggplot_na_imputations(data$GSPC.Adjusted, sp500_r,
                      theme = theme_bw())

data$GC.F.Adjusted <- gold_r
data$GSPC.Adjusted <- sp500_r

data <- subset(data, index(data) <= "2024-01-01")
colnames(data) <- c("BTC.USD.Adjusted",
                      "ETH.USD.Adjusted",
                      "BNB.USD.Adjusted",
                      "GOLD.USD.Adjusted",
                      "SP500.USD.Adjusted")
```

```{r}
# standardizzazione per visualizzare insieme
standardized_bnb <- scale(data$BTC.USD.Adjusted)
standardized_eth <- scale(data$ETH.USD.Adjusted)
standardized_btc <- scale(data$BNB.USD.Adjusted)
standardized_gold <- scale(data$GOLD.USD.Adjusted)
standardized_sp500 <- scale(data$SP500.USD.Adjusted)

cryptoScale <- cbind(standardized_btc, 
                     standardized_eth, 
                     standardized_bnb,
                     standardized_gold,
                     standardized_sp500)

dygraph(cryptoScale, main = "Comparazione Time Series (Riscalate)") %>%
  dySeries("BTC.USD.Adjusted", label = "BTC-USD", color = "red") %>%
  dySeries("ETH.USD.Adjusted", label = "ETH-USD", color = "blue") %>%
  dySeries("BNB.USD.Adjusted", label = "BNB-USD", color = "green") %>%
  dySeries("GOLD.USD.Adjusted", label = "GOLD-USD", color = "gold") %>%
  dySeries("SP500.USD.Adjusted", label = "SP500-USD", color = "brown")
```

Si nota facilmente come l'andamento delle criptovalute sia molto simile nel tempo. In particolare, dal grafico emergono due periodi in cui il mercato delle criptovalute sembra essere entrato in una sorta di "bolla", ossia dalla fine del 2017 al 2018 e dal 2021 all'inizio del 2022. Nel frattempo, per quanto riguarda gli altri due indici, notiamo un crollo dell'indice S&P 500 nel 2020, molto probabilmente causato dalla pandemia di Covid-19, seguito da una crescita negli anni successivi, simile a quella delle criptovalute. Per quanto riguarda l'oro, sembra seguire un trend positivo con una frenata nel periodo di forte crescita delle criptovalute.

Esaminiamo più da vicino i periodi di interesse, cercando di capire i comportamenti delle serie storiche guardando agli avvenimenti socio-economici:

1.  **Fine 2017 al 2018:** Le criptovalute subiscono una notevole crescita, diversamente dagli altri indici. Cià è dovuto principalmente a:

    -   **Frenesia speculativa e facilità d'accesso:** Durante il 2017, si è verificata una crescente frenesia speculativa intorno alle criptovalute, con sempre più investitori che entravano nel mercato per cercare guadagni rapidi. Questo è stato alimentato dall'euforia generale verso questo nuovo mercato, che sembrava offrire ritorni molto elevati grazie alla sua elevata volatilità. L'accesso al trading di criptovalute era reso molto più facile grazie alle nuove piattaforme di trading online e alle app di scambio di criptovalute, aumentando ulteriormente la domanda.

    -   **ICO (Initial Coin Offerings):** Le startup di blockchain hanno iniziato a implementare l'iniziativa ICO, raccogliendo fondi per i loro progetti accettando altre criptovalute come forma di pagamento. Queste ICO hanno alimentato ulteriormente l'entusiasmo intorno alle criptovalute e contribuito all'aumento della loro domanda.

2.  **Il 2020:** Mentre le criptovalute non subiscono cambiamenti significativi, notiamo comportamenti completamente diversi tra l'indice dell'oro, che cresce, e quello dell'S&P 500, che subisce un forte crollo seguito da una ripresa. Questo è dovuto a:

    1.  **Motivi della Crescita del Prezzo dell'Oro:**

        -   **Bene Rifugio**: La pandemia ha creato un'enorme incertezza negli investitori spingendoli a spostare i loro fondi verso asset sicuri come l'oro che è tradizionalmente considerato un bene di rifugio durante periodi di incertezza.

        -   **Debolezza del Dollaro e Inflazione**: L'incremento della liquidità e i tassi di interesse bassi dovuti alle politiche monetarie espansive delle banche centrali hanno indebolito il dollaro statunitense ed aumentato l'inflazione. Poiché l'oro è prezzato in dollari (ed è un bene di rifugio anche dall'inflazione), un dollaro più debole rende l'oro meno costoso per gli investitori che detengono altre valute, aumentandone così la domanda.

    2.  **Motivi del Comportamento dell'S&P 500:**

        -   **Crollo Iniziale**: La pandemia ha causato un blocco delle attività economiche a causa dei lockdown e delle misure di distanziamento sociale, portando a un crollo della domanda. L'incertezza riguardo alla durata e all'impatto della pandemia ha spinto gli investitori a vendere asset rischiosi, causando un rapido declino del mercato azionario.

        -   **Ripresa Successiva**: Gli enormi pacchetti di incentivi fiscali e le politiche monetarie delle banche centrali hanno fornito liquidità e supporto all'economia. Così con il passare del tempo, alcune economie hanno iniziato a riaprire e a recuperare. Inoltre le aziende tech, che costituiscono una parte significativa dell'S&P 500, hanno beneficiato molto del periodo Covid in quanto lo stare a casa ha forzato lo smart working e l'avvicinamento di molte persone alla tecnologia.

3.  **Dal 2021 all'inizio 2022:**

    Si osserva la fortissima crescita del mercato delle monete digitali, ma anche la crescita dell'S&P 500. Invece l'oro sembra arrestare la crescita e rimanere in stallo.

    1.  **Bolla del mercato Crypto & crescita S&P 500:**

        -   **Adozione e accettazione:** Durante il 2021, l'adozione soprattutto di Bitcoin ma anche delle altre crypto come forma sicura di pagamento è aumentata. Ad esempio, PayPal a fine 2020 inizià a permettere ai suoi utenti di acquistare, vendere e detenere Bitcoin e altre criptovalute direttamente attraverso la sua piattaforma. Anche altre aziende, come Square (2020), Tesla (2021) investirono in crypto currencies. Questi movimenti contribuirono all'aumento di fiducia degli investitori nelle monete digitali come forma di valuta e mezzo di scambio.

        -   **Investimenti in blockchain:** il mondo delle crypto ha acceso un faro molto grande sulla tecnologia della blockchain, così facendo tantissime nuove startup e grandi aziende hanno cominciato ad investire tante risorse in tal campo. La crescita della capitalizzazione di questo nuovo mercato è finito ad influenzare ovviamente l'indice S&P 500.

        -   **Conseguenza delle politiche di stimolo monetario adottate per il Covid:** La pandemia ha spinto molte banche centrali a implementare politiche di stimolo monetario per cercare di sostenere e rilanciare l'economie degli Stati. Ad esempio, la BCE attuà un piano d'emergenza di acquisto titoli (PEPP) di debito sia governativi che aziendali, abbassà i tassi di interesse per cercare di stimolare la spesa e gli investimenti e molte altre azioni. Come la BCE anche la Federal Reserve attuà politiche simili e tutto cià ha generato preoccupazioni riguardo l'inflazione che ha spinto gli investitori a cercare di proteggere il loro potere d'acquisto nel lungo periodo. Le crypto, soprattutto Bitcoin, sono state viste da molti come un'alternativa alla tradizionale protezione contro l'inflazione.

        -   **Interesse dei piccoli-medi investitori:** il 2021 ha visto anche un forte aumento dell'interesse dei piccoli investitori retail, spinti soprattutto dalla volatilità del mercato crypto e dunque visto come un' opportunità di investimento ad alto rendimento. Questo aumento della domanda da parte di investitori individuali ha contribuito all'incremento del prezzo medio delle crypto.

        Potremmo pensare che *Ethereum e BNB siano influenzate da Bitcoin*, essendo quest'ultimo la criptovaluta più famosa e di valore più alto. Tuttavia, è importante considerare che questa relazione potrebbe derivare da fattori comuni a tutte e tre le criptovalute, poiché condividono lo stesso mercato. Inoltre, *le comunità di Bitcoin ed Ethereum si sovrappongono spesso*, quindi molti investitori detengono entrambe le criptovalute e possono adottare strategie di trading simili, collegando di conseguenza i loro movimenti. Per non considerare il fatto che, Bitcoin ed Ethereum, essendo le criptovalute più grandi sul mercato, tendono a *reagire in modo simile agli eventi di mercato*, come notizie macroeconomiche o sviluppi tecnici, il che potrebbe correlarle attraverso il mercato stesso. Per quanto riguarda BNB, il suo legame con le altre due criptovalute potrebbe essere dovuto al fatto che è il token nativo della piattaforma di scambio di criptovalute Binance. Poiché Binance è diventata una delle principali piattaforme di scambio di criptovalute, le decisioni e le azioni intraprese da Binance possono influenzare il valore di BNB, collegandolo alle dinamiche di scambio di Bitcoin ed Ethereum.

    2.  **La "stallo" dell'oro:** questo comportamento è spiegabile osservando soprattutto il Bitcoin. BTC nasce con l'obiettivo di essere l'alternativa al denaro tradizionale ed *essere una nuova forma di denaro decentralizzata*. Per questo motivo moltissimi investitori hanno visto in Bitcoin il sostituto naturale dell'oro come riserva di valore e hanno cominciato a preferirlo in quanto si possono aspettare ritorni molto maggiori.

#### Misure di dipendenza tra serie storiche

La relazione che abbiamo ipotizzato esistere tra le currencies, cerchiamo di osservarla analiticamente attraverso l'utilizzo di strumenti grafici quali ad esempio lo Scatter Plot 3D. Per questa analisi, ma anche per molte altre successive, useremo per facilitare la visualizzazione solo i prezzi di chiusura aggiustati degli asset.

```{r, fig.height=3.5}
crypto <- cbind(data$BTC.USD.Adjusted, 
                data$ETH.USD.Adjusted, 
                data$BNB.USD.Adjusted)
colnames(crypto) <- c("BTC", "ETH", "BNB")
scatterplot3d(crypto$BTC, crypto$BNB, crypto$ETH,
              xlab = "BTC", ylab = "BNB", zlab = "ETH",
              color = "black",
              cex.symbols = 0.5,
              main = "Scatterplot 3D") 
```

Come si puà osservare sembra esserci un chiaro e forte legame positivo fra le tre serie storiche. Cià ci viene confermato anche dal calcolo della correlazione fra le serie:

```{r}
cor(crypto,use = "complete.obs")
```

ma dobbiamo prendere con le pinze questa informazione in quanto puà essere la conseguenza non solo dei fattori di mercato che abbiamo prima elencato ma anche un caso di correlazione spuria attraverso una caratteristica comune fra tre serie, il trend positivo.

Per questo motivo, eliminiamo il trend dalle serie, attraverso l'uso di una **differenza prima**, ed osserviamo se anche in questo caso esiste una relazione.

```{r}
cryptodiff <- cbind(diff(crypto$BTC)[-1], 
                    diff(crypto$ETH)[-1],
                    diff(crypto$BNB)[-1])
colnames(cryptodiff) <- c("BTC", "ETH", "BNB")

p7 <- ggplot(as.data.frame(cryptodiff), 
             aes(BTC,ETH)) +
  geom_point()+
  ggtitle("Scatterplot BTC - ETH")+
  theme_bw()
p8 <- ggplot(as.data.frame(cryptodiff), 
             aes(BTC,BNB)) +
  geom_point()+
  ggtitle("Scatterplot BTC - BNB")+
  theme_bw()
p9 <- ggplot(as.data.frame(cryptodiff), 
             aes(ETH,BNB)) +
  geom_point()+
  ggtitle("Scatterplot ETH - BNB")+
  theme_bw()

corr_matrix <- cor(cryptodiff, use = "complete.obs")
corr_df <- melt(corr_matrix)

p10 <- ggplot(data = corr_df, aes(Var1, Var2)) +
  geom_tile(aes(fill = value), color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black") +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0.2, limits = c(-1, 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Matrice di correlazione", x = NULL, y = NULL) +
  coord_fixed()

grid.arrange(p7, p8, p9,p10, ncol = 2, nrow = 2)
```

Togliendo il trend la correlazione tra le serie storiche cala, ma è ancora una correlazione positiva. Dunque, possiamo dire che tra le tre crypto è un legame positivo.

Osserviamo ora le relazioni con gli altri indici finanziari.

```{r}
GGally::ggpairs(as.data.frame(data))+theme_bw()
```

Dagli scatterplott fra le varie serie storiche si nota un legame positivo forte, ma esattamente come nel caso precedente dove stavamo analizzando solo le crypto, anche qui puà essere forviante tenuto conto della tendenza crescente di tutti gli asset. Per questo motivo osserviamo le correlazioni delle serie ottenute dalla **differenza prima.**

```{r}
datadiff <- cbind(diff(data$BTC.USD.Adjusted)[-1], 
                  diff(data$ETH.USD.Adjusted)[-1],
                  diff(data$BNB.USD.Adjusted)[-1],
                  diff(data$GOLD.USD.Adjusted)[-1],
                  diff(data$SP500.USD.Adjusted)[-1])
colnames(datadiff) <- c("BTC", "ETH", "BNB", "GOLD", "S&P500")
GGally::ggpairs(as.data.frame(datadiff))+theme_bw()
```

Ora è ben evidente come, eliminata la caratteristica di trend, le serie delle crypto sono sono poco legate linearmente con gli altri due indici. Leggermente di più con S&P 500.

Inoltre, osservando le time series di tutti gli oggetti finanziari che stiamo usando, possiamo affermare che nessuna è stazionaria in quanto non rispettano i criteri di stazionarietà avendo variabilità non costante nel tempo, cambi di livello e trend.

```{r, include=FALSE}
plot_acf <- function(data, titolo) {
  cryptoAcf <- ggAcf(data, lag.max = 365, plot = FALSE)
  #intervallo di confidenza al 95%
  ci <- 1.96 / sqrt(length(data))
  
  df <- data.frame(lag = cryptoAcf$lag[2:length(cryptoAcf$lag)], 
                   acf = cryptoAcf$acf[2:length(cryptoAcf$acf)])
  
  # Aggiungo la categoriale per i multipli di 7 e 30
  df$multipli <- ifelse(
    df$lag %% 7 == 0 & df$lag %% 30 == 0, "Multipli di 7 e 30",
    ifelse(df$lag %% 7 == 0, "Multipli di 7",
           ifelse(df$lag %% 30 == 0, "Multipli di 30",
                  "Nessuno")))
  
  # grafico dell'ACF
  ggplot(df, aes(lag, acf, fill = multipli)) +
    geom_bar(stat = "identity", position = "dodge", width = 0.5) +
    geom_hline(yintercept = c(-ci, ci), 
               linetype = "dashed", color = "#00008B") +
    xlab("lag") + ylab("ACF") +
    ggtitle(titolo) + theme_bw() +
    scale_fill_manual(values = c("blue", "green", "red", "#D3D3D3"),
                      labels = c("Multipli di 7 e 30", "Multipli di 7", "Multipli di 30", "Nessuno"), 
                      name = NULL) +
    theme(legend.position = "bottom", legend.key.size = unit(0.5, "lines"))
}

```

### Analisi delle caratteristiche delle Time Series

Focalizziamoci ora sull'analisi delle singole serie storiche per identificarne le caratteristiche che le compongono: Trend, Stagionalità e Ciclicità

Per avere una dimostrazione di cià osserviamo i rispettivi Correlogrammi e Seasonal plots.

-   L'ACF è utile per identificare serie storiche stazionarie o non-stazionarie:
    -   L'ACF per una serie storica non stazionaria diminuisce lentamente;
    -   Per i dati non stazionari, il valore di $\hat p (1)$ è spesso grande e positivo.
-   I Seasonal Plots ci permettono di osservare il comportamento delle serie negli anni rispetto a periodi temporali. In questo caso, ho abbassato la frequenza dei dati da giornalieri a mensili, per cercare di catturare un eventuale andamento stagionale mensile dei dati

**Currencies**

```{r, fig.height=3}
btcMonth <- apply.monthly(btc_data, FUN = median)
p1 <- ggseasonplot(ts(btcMonth, frequency = 12), polar = TRUE)+
  ggtitle("BTC-USD\nPolar seasonal plot mensile")+
  theme_bw()

p2 <- ggsubseriesplot(ts(btcMonth, frequency = 12))+
  ggtitle("BTC-USD\nseasonal subseries plot mensile")+
  ylab("")+
  theme_bw()

plot_acf(btc_data, "Bitcoin - ACF plot")
grid.arrange(p1, p2, ncol = 2)
```

```{r, fig.height=3}
ethMonth <- apply.monthly(eth_data, FUN = median)
p3 <- ggseasonplot(ts(ethMonth, frequency = 12), polar = TRUE)+
  ggtitle("ETH-USD\nPolar seasonal plot mensile")+
  theme_bw()

p4 <- ggsubseriesplot(ts(ethMonth, frequency = 12))+
  ggtitle("ETH-USD\nseasonal subseries plot mensile")+
  ylab("")+
  theme_bw()

plot_acf(eth_data, "Ethereum - ACF plot")
grid.arrange(p3, p4, ncol = 2)
```

```{r, fig.height=3}
bnbMonth <- apply.monthly(bnb_data, FUN = median)
p5 <- ggseasonplot(ts(bnbMonth, frequency = 12), polar = TRUE)+
  ggtitle("BNB-USD\nPolar seasonal plot mensile")+
  theme_bw()

p6 <- ggsubseriesplot(ts(bnbMonth, frequency = 12))+
  ggtitle("BNB-USD\nseasonal subseries plot mensile")+
  ylab("")+
  theme_bw()

plot_acf(bnb_data, "Binance Coin - ACF plot")
grid.arrange(p5, p6, ncol = 2)
```

Dai grafici, possiamo notare che tutte e tre le criptovalute mostrano un trend positivo, confermando quanto osservato all'inizio dell'analisi. Nei Seasonal Plot, sembra esserci una leggera stagionalità mensile, con i prezzi delle criptovalute che raggiungono un picco solitamente nei mesi di giugno/luglio seguito da una flessione. Tuttavia, questa stagionalità non è evidente nell'ACF. Questo comportamento osservato nei seasonal plot potrebbe essere dovuto al fatto che, per effettuare la rappresentazione, ho dovuto ridurre la frequenza delle serie da giornaliera a mensile considerando la mediana dei valori per mese. Questo processo semplifica le informazioni, quindi potrebbe aver enfatizzato un comportamento che in realtà nella serie non è presente (o almeno non così forte).

**Oro e S&P 500**

```{r, fig.height=3}
goldMonth <- apply.monthly(gold_data, FUN = median)
p11 <- ggseasonplot(ts(goldMonth, frequency = 12), polar = TRUE)+
  ggtitle("GOLD-USD\nPolar seasonal plot mensile")+
  theme_bw()

p12 <- ggsubseriesplot(ts(goldMonth, frequency = 12))+
  ggtitle("GOLD-USD\nseasonal subseries plot mensile")+
  ylab("")+
  theme_bw()

plot_acf(gold_data, "GOLD - ACF plot")
grid.arrange(p11, p12, ncol = 2)
```

```{r, fig.height=3}
sp500Month <- apply.monthly(sp500_data, FUN = median)
p13 <- ggseasonplot(ts(sp500Month, frequency = 12), polar = TRUE)+
  ggtitle("S&P 500\nPolar seasonal plot mensile")+
  theme_bw()

p14 <- ggsubseriesplot(ts(sp500Month, frequency = 12))+
  ggtitle("S&P 500\nseasonal subseries plot mensile")+
  ylab("")+
  theme_bw()

plot_acf(sp500_data, "S&P 500 - ACF plot")
grid.arrange(p13, p14, ncol = 2)
```

Dai grafici dell'oro e dell'S&P 500, possiamo notare invece che nonostante l'uso di tale processo di semplificazione, la caratteristica stagionale non è presente. Si osserva solo un trend positivo.

## Regressione & Previsioni

L'obiettivo di questo progetto è individuare una relazione tra mercati distinti al fine di poter effettuare previsioni sull'andamento di una criptovaluta. Per condurre questa analisi, non userà più le serie storiche originali, bensì le corrispondenti serie stazionarie ottenute tramite un processo di decomposizione.

### Decomposizione - Daily log-returns

Poiché, per rendere stazionarie le serie dei prezzi giornalieri ci basta effettuare una semplice differenza prima, in quanto per questa tipologia di serie storiche non si ha stagionalità. Calcoleremo la serie dei **daily log-returns** ossia i rendimenti ottenuti come differenza prima dei prezzi (logaritmici), che coinciderà con la componente residua che avremmo ottenuto dalla decomposizione.

**Rendimenti logaritmici giornalieri**

Il rendimento logaritmico è definito come

$$
r_{t} = \ln\biggl( \dfrac{P_{t}}{P_{t-1}} \biggr) = \ln(P_{t}) - \ln(P_{t-1})
$$

dove $P_{t}$ è il prezzo al tempo $t$ e $P_{t-1}$ è il prezzo al tempo precedente, nel nostro caso al giorno prima.\
Osservando la formula, il rendimento logaritmico puà essere calcolato semplicemente *prendendo la differenza prima dei logaritmi naturali dei prezzi.*

Sappiamo che utilizzando il metodo della differenza prima andiamo ad eliminare eventuali tendenze di trend/ciclo da una serie storica. Dunque, catturiamo sicuramente questa caratteristica e inoltre effettuando il logaritmo andiamo a gestire anche il caso della variabilità non costante nel tempo.\
Osserviamo come cambiano le serie estraendo i rendimenti logaritmici giornalieri:

```{r, include=FALSE}
returnsBTC <- diff(log(data$BTC.USD.Adjusted))[-1]
returnsETH <- diff(log(data$ETH.USD.Adjusted))[-1]
returnsBNB <- diff(log(data$BNB.USD.Adjusted))[-1]
returnsGOLD <- diff(log(data$GOLD.USD.Adjusted))[-1]
returnsSP500 <- diff(log(data$SP500.USD.Adjusted))[-1]

returns <- cbind(returnsBTC, returnsETH, returnsBNB, returnsGOLD, returnsSP500)

colnames(returns) <- c("returnsBTC", "returnsETH", "returnsBNB", "returnsGOLD", "returnsSP500")
```

```{r, fig.height=2}
dygraph(data$BTC.USD.Adjusted, main = "BTC ")%>%
  dyOptions(colors = "#00008B")
dygraph(log(data$BTC.USD.Adjusted), main = "Log - BTC")%>%
  dyOptions(colors = "#00008B")
dygraph(returns$returnsBTC, main = "Daily log-returns BTC")%>%
  dyOptions(colors = "#00008B")
```

```{r, fig.height=3}
hist_btc <- gghistogram(returns$returnsBTC, add.normal = TRUE) +
  xlab("daily log-returns")+
  ylab("frequenza")+
  ggtitle("Istogramma BTC daily log-returns")+
  theme_bw()

acf_btc <- plot_acf(returns$returnsBTC, "ACF rendimenti Bitcoin")

grid.arrange(hist_btc,acf_btc,ncol = 2)
```

```{r, out.height=2.5}
Box.test(returns$returnsBTC,fitdf=0)
Box.test(returns$returnsBTC,fitdf=0,type="Ljung")
```

Come si puà ben osservare sia dai grafici ottenuti che dai test statistici la serie dei rendimenti logaritmici di BTC segue un andamento white noise. In generale, cià è vero per tutte le serie che sto considerando per questo considereremo le serie ottenute da tale procedimento nella fase di previsione.

**Obiettivo**

L'obiettivo di questa fase è quella di cercare di effettuare, per quanto possibile, previsioni di una crypto. Più nello specifico tenterà di fare previsioni rispetto alla serie storica di Binance Coin. Ho scelto BNB in quanto è più elastica alle variazioni di ETH e BTC a causa della relazione descritta durante la fase di analisi.\
Per farlo, seguirà due strade costruendo altrettanti modelli di regressione lineare:

1.  *Modello di regressione lineare che consideri la serie storica della currency BNB in relazione con le altre.*
2.  *Modello di regressione lineare che considera la sola serie storica della currency;*

### Primo Modello

Partiamo con il visualizzare le relazioni tra la nostra variabile dipendente e i regressori ed anche tra i regressori stessi.

```{r, fig.height=3.5}
corr <- cor(returns, use = "complete.obs")
cor_df <- melt(corr)

ggplot(data = cor_df, aes(Var1, Var2)) +
  geom_tile(aes(fill = value), color = "white") +
  geom_text(aes(label = round(value, 2)), color = "black") +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", midpoint = 0.2, limits = c(-1, 1)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Matrice di correlazione", x = NULL, y = NULL) +
  coord_fixed()
```

Come avevamo visto anche per le relazioni tra le sole serie ottenute per differenza prima, anche per i rendimenti si osserva:

-   Correlazioni elevate tra rendimenti delle criptovalute;
-   Correlazioni moderate con gli indici tradizionali;

Ma in più dobbiamo evidenziare che ci potrebbero essere problemi di **multicollinearit?**\
a causa delle alte correlazioni tra i rendimenti di Bitcoin e Ethereum. Questo comportamento puà essere corretto utilizzando tecniche di regolarizzazione come Ridge o Lasso.

Potremmo quindi utilizzare un modello di regressione lineare di questo tipo: $$
bnb_R = \beta_0 
+ \beta_1\cdot btc_R 
+ \beta_2\cdot eth_R
+ \beta_3\cdot gold_R
+ \beta_4\cdot sp500_R
+ \epsilon_{t}
$$

```{r}
bnb_r <- as.ts(returns$returnsBNB)
btc_r <- as.ts(returns$returnsBTC)
eth_r <- as.ts(returns$returnsETH)
gold_r <- as.ts(returns$returnsGOLD)
sp500_r <- as.ts(returns$returnsSP500)

fit1 <- tslm(bnb_r ~ btc_r + eth_r + gold_r + sp500_r)
summary(fit1)
```

```{r}
bnb_r_train <- head(bnb_r, 1795)
btc_r_train <- head(btc_r, 1795)
eth_r_train <- head(eth_r, 1795)
gold_r_train <- head(gold_r, 1795)
sp500_r_train <- head(sp500_r, 1795)

trainset <- data.frame(
  btc = btc_r_train,
  eth = eth_r_train,
  gold = gold_r_train,
  sp500 = sp500_r_train
)

bnb_r_test <- tail(bnb_r, 449)
btc_r_test <- tail(btc_r, 449)
eth_r_test <- tail(eth_r, 449)
gold_r_test <- tail(gold_r, 449)
sp500_r_test <- tail(sp500_r, 449)

testset <- data.frame(
  btc = btc_r_test,
  eth = eth_r_test,
  gold = gold_r_test,
  sp500 = sp500_r_test
)


# Addestramento del modello con dati di addestramento
mod1 <- tslm(bnb_r_train ~ btc + eth + gold + sp500, data = trainset)

# Previsioni solo per il set di dati di test
prev1 <- predict(mod1, newdata = testset)

risultati <- cbind(
  bnb_r_test,
  ts(prev1, start = 1796, end = 2244, frequency = 1)
)

colnames(risultati) <- c("bnbTEST", "bnbPrev")

dygraph(risultati, main = "Previsioni Rendimenti osservate sulla serie di Test") %>%
  dySeries("bnbTEST", label = "Serie di TEST", color = "blue") %>%
  dySeries("bnbPrev", label = "Previsioni", color = "red")
```

Misuriamo l'accuratezza del modello:

```{r}
accuracy(fit1, test = seq(1795,2244))
```

### Secondo Modello

Nel modello considereremo come caratteristica il trend estraendolo calcolando la media ponderata di ordine 7, in quanto i dati sono giornalieri quindi avrebbe senso usare una finestra o settimanale, o mensile ecc. In più, essendo la serie soggetta a molta volatilità è consigliabile usare una finestra di dati non troppo piccola per evitare overfitting ai dati.

Il modello sarà$$
bnb = \beta_0 
+ \beta_1\cdot trend + \epsilon_{t}
$$

```{r}
bnbTS <- as.ts(data$BNB.USD.Adjusted)
fit2 <- tslm(bnbTS ~ ma(bnbTS, 7))
summary(fit2)
```

```{r, fig.height5}
bnb.train <- head(bnbTS, 1796)
bnb.train <- as.data.frame(bnb.train)
bnb.test <- tail(bnbTS, 449)
bnb.test <- as.data.frame(bnb.test)


mod2 <- tslm(x ~ ma(x, 7), data = bnb.train)
prev2 <- predict(mod2, newdata = bnb.test)

bnbTest<-bnb.test$x

testing <- cbind(ts(bnbTest, start = 1797, end = 2245, frequency = 1), 
                 ts(prev2, start = 1797, end = 2245, frequency = 1))
colnames(testing) <- c("bnbTEST", "bnbPrev")

dygraph(testing, main = "Previsioni BNB osservate sulla serie di Test") %>%
  dySeries("bnbTEST", label = "Serie di TEST", color = "blue") %>%
  dySeries("bnbPrev", label = "Previsioni", color = "red")
```

Misuriamo l'accuratezza del modello:

```{r}
accuracy(fit2, test = seq(1797,2245))
```

**Confronto modelli su previsioni LOO-CV**

Per testare quale fra i due modelli costruiti è quello migliore, confronteremo i risultati delle metriche di previsione ottenute utilizzando la Leave-One-Out Cross-Validation.

-   *Metriche del primo modello:*

```{r}
CV(fit1)
```

-   *Metriche del secondo modello:*

```{r}
CV(fit2)
```

### **Conclusione**

Dal confronto delle metriche tra i due modelli, possiamo osservare quanto segue:

1.  **RMSE (Root Mean Squared Error)**: Il primo modello ha un RMSE (0.0195) significativamente inferiore rispetto al RMSE del secondo modello (5.4201). Questo indica che le previsioni del primo modello sono più accurate rispetto a quelle del secondo modello.

2.  **MAE (Mean Absolute Error)**: Anche il MAE del modello primo (0.0128) modello è notevolmente inferiore rispetto a quello del secondo modello (3.63337).

3.  **CV (Coefficient of Variation)**: Il CV del primo modello (0.0015) è notevolmente più basso rispetto a quello del secondo modello (69.0194). Un CV più basso indica maggiore stabilità e precisione delle previsioni.

4.  **AIC (Akaike Information Criterion)** e **BIC (Bayesian Information Criterion)**: Entrambi i criteri di informazione (AIC e BIC) sono inferiori per il primo modello rispetto al secondo. Questo suggerisce che il primo è preferibile in termini di adattamento ai dati e complessità.

5.  **AdjR2 (Adjusted R-squared)**: L'R2-aggiustato per il secondo modello è notevolmente più alto rispetto a quello del primo. Tuttavia, dato il confronto delle altre metriche che indicano la precisione delle previsioni, l'AdjR2 da solo non è sufficiente per determinare quale modello sia migliore.

In sintesi, possiamo affermare che sulla base delle metriche presentate, il primo modello è preferibile rispetto al secondo modello in quanto mostra una maggiore accuratezza delle previsioni, minore variabilità e migliori valori di AIC e BIC.
